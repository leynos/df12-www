<!doctype html>
<html lang="en" data-theme="df12">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="assets/site.css" rel="stylesheet" />
  <title>df12 Productions — Resource Acquisition Is Initialization (RAII) test clusters | pg-embedded-setup-unpriv</title>
  <style>
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #49483e }
.codehilite { background: #272822; color: #F8F8F2 }
.codehilite .c { color: #959077 } /* Comment */
.codehilite .err { color: #ED007E; background-color: #1E0010 } /* Error */
.codehilite .esc { color: #F8F8F2 } /* Escape */
.codehilite .g { color: #F8F8F2 } /* Generic */
.codehilite .k { color: #66D9EF } /* Keyword */
.codehilite .l { color: #AE81FF } /* Literal */
.codehilite .n { color: #F8F8F2 } /* Name */
.codehilite .o { color: #FF4689 } /* Operator */
.codehilite .x { color: #F8F8F2 } /* Other */
.codehilite .p { color: #F8F8F2 } /* Punctuation */
.codehilite .ch { color: #959077 } /* Comment.Hashbang */
.codehilite .cm { color: #959077 } /* Comment.Multiline */
.codehilite .cp { color: #959077 } /* Comment.Preproc */
.codehilite .cpf { color: #959077 } /* Comment.PreprocFile */
.codehilite .c1 { color: #959077 } /* Comment.Single */
.codehilite .cs { color: #959077 } /* Comment.Special */
.codehilite .gd { color: #FF4689 } /* Generic.Deleted */
.codehilite .ge { color: #F8F8F2; font-style: italic } /* Generic.Emph */
.codehilite .ges { color: #F8F8F2; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #F8F8F2 } /* Generic.Error */
.codehilite .gh { color: #F8F8F2 } /* Generic.Heading */
.codehilite .gi { color: #A6E22E } /* Generic.Inserted */
.codehilite .go { color: #66D9EF } /* Generic.Output */
.codehilite .gp { color: #FF4689; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { color: #F8F8F2; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #959077 } /* Generic.Subheading */
.codehilite .gt { color: #F8F8F2 } /* Generic.Traceback */
.codehilite .kc { color: #66D9EF } /* Keyword.Constant */
.codehilite .kd { color: #66D9EF } /* Keyword.Declaration */
.codehilite .kn { color: #FF4689 } /* Keyword.Namespace */
.codehilite .kp { color: #66D9EF } /* Keyword.Pseudo */
.codehilite .kr { color: #66D9EF } /* Keyword.Reserved */
.codehilite .kt { color: #66D9EF } /* Keyword.Type */
.codehilite .ld { color: #E6DB74 } /* Literal.Date */
.codehilite .m { color: #AE81FF } /* Literal.Number */
.codehilite .s { color: #E6DB74 } /* Literal.String */
.codehilite .na { color: #A6E22E } /* Name.Attribute */
.codehilite .nb { color: #F8F8F2 } /* Name.Builtin */
.codehilite .nc { color: #A6E22E } /* Name.Class */
.codehilite .no { color: #66D9EF } /* Name.Constant */
.codehilite .nd { color: #A6E22E } /* Name.Decorator */
.codehilite .ni { color: #F8F8F2 } /* Name.Entity */
.codehilite .ne { color: #A6E22E } /* Name.Exception */
.codehilite .nf { color: #A6E22E } /* Name.Function */
.codehilite .nl { color: #F8F8F2 } /* Name.Label */
.codehilite .nn { color: #F8F8F2 } /* Name.Namespace */
.codehilite .nx { color: #A6E22E } /* Name.Other */
.codehilite .py { color: #F8F8F2 } /* Name.Property */
.codehilite .nt { color: #FF4689 } /* Name.Tag */
.codehilite .nv { color: #F8F8F2 } /* Name.Variable */
.codehilite .ow { color: #FF4689 } /* Operator.Word */
.codehilite .pm { color: #F8F8F2 } /* Punctuation.Marker */
.codehilite .w { color: #F8F8F2 } /* Text.Whitespace */
.codehilite .mb { color: #AE81FF } /* Literal.Number.Bin */
.codehilite .mf { color: #AE81FF } /* Literal.Number.Float */
.codehilite .mh { color: #AE81FF } /* Literal.Number.Hex */
.codehilite .mi { color: #AE81FF } /* Literal.Number.Integer */
.codehilite .mo { color: #AE81FF } /* Literal.Number.Oct */
.codehilite .sa { color: #E6DB74 } /* Literal.String.Affix */
.codehilite .sb { color: #E6DB74 } /* Literal.String.Backtick */
.codehilite .sc { color: #E6DB74 } /* Literal.String.Char */
.codehilite .dl { color: #E6DB74 } /* Literal.String.Delimiter */
.codehilite .sd { color: #E6DB74 } /* Literal.String.Doc */
.codehilite .s2 { color: #E6DB74 } /* Literal.String.Double */
.codehilite .se { color: #AE81FF } /* Literal.String.Escape */
.codehilite .sh { color: #E6DB74 } /* Literal.String.Heredoc */
.codehilite .si { color: #E6DB74 } /* Literal.String.Interpol */
.codehilite .sx { color: #E6DB74 } /* Literal.String.Other */
.codehilite .sr { color: #E6DB74 } /* Literal.String.Regex */
.codehilite .s1 { color: #E6DB74 } /* Literal.String.Single */
.codehilite .ss { color: #E6DB74 } /* Literal.String.Symbol */
.codehilite .bp { color: #F8F8F2 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #A6E22E } /* Name.Function.Magic */
.codehilite .vc { color: #F8F8F2 } /* Name.Variable.Class */
.codehilite .vg { color: #F8F8F2 } /* Name.Variable.Global */
.codehilite .vi { color: #F8F8F2 } /* Name.Variable.Instance */
.codehilite .vm { color: #F8F8F2 } /* Name.Variable.Magic */
.codehilite .il { color: #AE81FF } /* Literal.Number.Integer.Long */

    .codehilite {
      background-color: var(--color-neutral);
      border-radius: 0.75rem;
      padding: 1.25rem;
      color: var(--color-neutral-content);
      font-family: "IBM Plex Mono", monospace;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
      overflow: hidden;
    }

    .codehilite pre {
      margin: 0;
      background: transparent;
      font-family: inherit;
      font-size: inherit;
      border: none;
      padding: 0;
      box-shadow: none;
      overflow-x: auto;
    }

    .codehilite__chrome {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.7rem;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
      gap: 1rem;
    }

    .codehilite__language {
      white-space: nowrap;
    }

    .codehilite__copy {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      color: var(--color-neutral-content);
      font-family: inherit;
      font-size: 0.65rem;
      text-transform: uppercase;
      padding: 0.2rem 0.9rem;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .codehilite__copy:hover,
    .codehilite__copy:focus-visible {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .codehilite__copy[data-state="copied"] {
      background: var(--color-accent);
      color: var(--color-accent-content);
      border-color: transparent;
    }

    .codehilite__copy-icon {
      width: 0.85rem;
      height: 0.85rem;
      display: block;
    }

    .svg-inline--fa {
      display: inline;
    }
  </style>
</head>
<body class="doc-page">
  <a href="#main-content" class="skip-link sr-only-focusable">Skip to content</a>

  <header id="site-header" class="fixed inset-x-0 top-0 z-50 border-b border-base-200 bg-base-100/80 backdrop-blur supports-[backdrop-filter]:bg-base-100/60">
    <div class="layout-shell layout-shell--docs flex w-full items-center justify-between px-4 py-4 md:px-8">
      <a href="index.html" class="group flex items-center gap-3 font-mono text-lg font-bold uppercase tracking-[0.35em] text-base-content">
        <span class="flex h-9 w-9 items-center justify-center transition-transform duration-300 group-hover:rotate-45">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <rect x="12" width="16.9706" height="16.9706" transform="rotate(45 12 0)" />
          </svg>
        </span>
        df12
      </a>
      <nav aria-label="Primary navigation" class="hidden items-center gap-8 md:flex">
        <a href="index.html#systems" class="nav-link hit-target">Tools</a>
        <a href="index.html#worlds" class="nav-link hit-target" data-variant="accent">Creative</a>
        <a href="docs.html" class="nav-link hit-target" data-variant="neutral" aria-current="page">Docs</a>
      </nav>
      <div class="md:hidden">
        <details class="dropdown dropdown-end">
          <summary class="btn btn-ghost btn-sm font-mono uppercase tracking-[0.3em]">Menu</summary>
          <ul class="menu dropdown-content menu-sm z-[1] mt-2 w-44 rounded-box bg-base-100 p-2 shadow">
            <li><a href="index.html#systems" class="nav-link hit-target w-full justify-start">Tools</a></li>
            <li><a href="index.html#worlds" class="nav-link hit-target w-full justify-start" data-variant="accent">Creative</a></li>
            <li><a href="docs.html" class="nav-link hit-target w-full justify-start" data-variant="neutral" aria-current="page">Docs</a></li>
          </ul>
        </details>
      </div>
    </div>
  </header>

  <main id="main-content" class="px-4 pb-24 pt-32">
    <div class="layout-shell layout-shell--docs doc-grid">
      <aside class="doc-sidebar" aria-label="Documentation navigation">
        <div class="doc-sidebar__panel">
          <a href="docs.html" class="doc-sidebar__back">
            <iconify-icon icon="carbon:arrow-left" class="h-4 w-4" aria-hidden="true"></iconify-icon>
            Back to docs
          </a>
          <div>
            <p class="doc-sidebar__eyebrow">pg-embedded-setup-unpriv</p>
            <p class="doc-sidebar__body">Bootstrap `postgresql_embedded` clusters as root while delegating filesystem work to unprivileged users. Keep CI environments reproducible without burning down your permissions tree.
</p>
          </div>
          <div class="doc-sidebar__groups">
              <div class="doc-nav-group" aria-label="Prerequisites">
                <h3 class="doc-nav-group__title " >
                  <a href="docs-pg-embedded-prerequisites.html">Prerequisites</a>
                </h3>
              </div>
              <div class="doc-nav-group" aria-label="Quick start">
                <h3 class="doc-nav-group__title " >
                  <a href="docs-pg-embedded-quick-start.html">Quick start</a>
                </h3>
              </div>
              <div class="doc-nav-group" aria-label="Bootstrap for test suites">
                <h3 class="doc-nav-group__title " >
                  <a href="docs-pg-embedded-bootstrap-for-test-suites.html">Bootstrap for test suites</a>
                </h3>
              </div>
              <div class="doc-nav-group" aria-label="Resource Acquisition Is Initialization (RAII) test clusters">
                <h3 class="doc-nav-group__title is-active" aria-current="page">
                  <a href="docs-pg-embedded-resource-acquisition-is-initialization-raii-test-clusters.html">Resource Acquisition Is Initialization (RAII) test clusters</a>
                </h3>
                  <ul class="doc-nav__list" role="list">
                      <li>
                        <a href="docs-pg-embedded-resource-acquisition-is-initialization-raii-test-clusters.html#resource-acquisition-is-initialization-raii-test-clusters-using-the-rstest-fixture"
                           class="doc-nav__link "
>
                          <span>Using the `rstest` fixture</span>
                        </a>
                      </li>
                      <li>
                        <a href="docs-pg-embedded-resource-acquisition-is-initialization-raii-test-clusters.html#resource-acquisition-is-initialization-raii-test-clusters-connection-helpers-and-diesel-integration"
                           class="doc-nav__link "
>
                          <span>Connection helpers and Diesel integration</span>
                        </a>
                      </li>
                  </ul>
              </div>
              <div class="doc-nav-group" aria-label="Privilege detection and idempotence">
                <h3 class="doc-nav-group__title " >
                  <a href="docs-pg-embedded-privilege-detection-and-idempotence.html">Privilege detection and idempotence</a>
                </h3>
              </div>
              <div class="doc-nav-group" aria-label="Integrating with root-only test agents">
                <h3 class="doc-nav-group__title " >
                  <a href="docs-pg-embedded-integrating-with-root-only-test-agents.html">Integrating with root-only test agents</a>
                </h3>
              </div>
              <div class="doc-nav-group" aria-label="Known issues and mitigations">
                <h3 class="doc-nav-group__title " >
                  <a href="docs-pg-embedded-known-issues-and-mitigations.html">Known issues and mitigations</a>
                </h3>
              </div>
              <div class="doc-nav-group" aria-label="Further reading">
                <h3 class="doc-nav-group__title " >
                  <a href="docs-pg-embedded-further-reading.html">Further reading</a>
                </h3>
              </div>
          </div>
          <div>
            <p class="doc-sidebar__section-label">Source</p>
            <a class="inline-flex items-center gap-2 font-semibold text-primary" href="https://raw.githubusercontent.com/leynos/pg-embedded-setup-unpriv/refs/tags/v0.1.0/docs/users-guide.md" target="_blank" rel="noopener">
              View markdown
              <iconify-icon icon="carbon:arrow-up-right" aria-hidden="true"></iconify-icon>
            </a>
            <p class="mt-1 text-xs text-base-content/60">Source material</p>
          </div>
        </div>
      </aside>

      <section class="space-y-6" id="resource-acquisition-is-initialization-raii-test-clusters">
        <nav class="doc-mobile-nav" aria-labelledby="mobile-sections-label">
          <p id="mobile-sections-label" class="doc-sidebar__section-label">Contents</p>
          <ul class="doc-nav__list doc-nav__list--mobile" role="list">
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Prerequisites</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-prerequisites.html" class="doc-nav__link">Prerequisites</a>
                    </li>
                </ul>
              </li>
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Quick start</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-quick-start.html" class="doc-nav__link">Quick start</a>
                    </li>
                </ul>
              </li>
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Bootstrap for test suites</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-bootstrap-for-test-suites.html" class="doc-nav__link">Bootstrap for test suites</a>
                    </li>
                </ul>
              </li>
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Resource Acquisition Is Initialization (RAII) test clusters</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-resource-acquisition-is-initialization-raii-test-clusters.html" class="doc-nav__link">Resource Acquisition Is Initialization (RAII) test clusters</a>
                    </li>
                    <li>
                      <a href="docs-pg-embedded-resource-acquisition-is-initialization-raii-test-clusters.html#resource-acquisition-is-initialization-raii-test-clusters-using-the-rstest-fixture" class="doc-nav__link">Using the `rstest` fixture</a>
                    </li>
                    <li>
                      <a href="docs-pg-embedded-resource-acquisition-is-initialization-raii-test-clusters.html#resource-acquisition-is-initialization-raii-test-clusters-connection-helpers-and-diesel-integration" class="doc-nav__link">Connection helpers and Diesel integration</a>
                    </li>
                </ul>
              </li>
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Privilege detection and idempotence</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-privilege-detection-and-idempotence.html" class="doc-nav__link">Privilege detection and idempotence</a>
                    </li>
                </ul>
              </li>
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Integrating with root-only test agents</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-integrating-with-root-only-test-agents.html" class="doc-nav__link">Integrating with root-only test agents</a>
                    </li>
                </ul>
              </li>
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Known issues and mitigations</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-known-issues-and-mitigations.html" class="doc-nav__link">Known issues and mitigations</a>
                    </li>
                </ul>
              </li>
              <li class="doc-nav-group">
                <h3 class="doc-nav-group__title">Further reading</h3>
                <ul class="doc-nav__list doc-nav__list--mobile" role="list">
                    <li>
                      <a href="docs-pg-embedded-further-reading.html" class="doc-nav__link">Further reading</a>
                    </li>
                </ul>
              </li>
          </ul>
        </nav>

        <header class="doc-hero" id="doc-title">
          <h1 class="doc-hero__title">Resource Acquisition Is Initialization (RAII) test clusters</h1>
          <div class="doc-meta-list">
              <span class="doc-meta-list__item">Version 0.1.0</span>
            <span class="doc-meta-list__item">Updated Nov 08, 2025</span>
          </div>
        </header>

        <article class="doc-article">
              <section class="doc-section">
                <div class="doc-prose"><p><code>pg_embedded_setup_unpriv::TestCluster</code> wraps <code>bootstrap_for_tests()</code> with a
Resource Acquisition Is Initialization (RAII) lifecycle. Constructing the guard
starts PostgreSQL using the discovered settings, applies the environment
produced by the bootstrap helper, and exposes the configuration to callers.
Dropping the guard stops the instance and restores the prior process
environment, so subsequent tests start from a clean slate.</p>
<div class="codehilite" data-language="rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">pg_embedded_setup_unpriv</span><span class="p">::{</span><span class="n">TestCluster</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">::</span><span class="n">BootstrapResult</span><span class="p">};</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">exercise_cluster</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">BootstrapResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestCluster</span><span class="p">::</span><span class="n">new</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster</span><span class="p">.</span><span class="n">settings</span><span class="p">().</span><span class="n">url</span><span class="p">(</span><span class="s">&quot;app_db&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Issue queries using any preferred client here.</span>
<span class="w">    </span><span class="nb">drop</span><span class="p">(</span><span class="n">cluster</span><span class="p">);</span><span class="w"> </span><span class="c1">// PostgreSQL shuts down automatically.</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>The guard keeps <code>PGPASSFILE</code>, <code>TZ</code>, <code>TZDIR</code>, and the XDG directories populated
for the duration of its lifetime, making synchronous tests usable without extra
setup. Unit and behavioural tests assert that <code>postmaster.pid</code> disappears after
drop, demonstrating that no orphaned processes remain.</p></div>
              </section>
                <section id="resource-acquisition-is-initialization-raii-test-clusters-using-the-rstest-fixture" class="doc-section">
                  <div class="doc-section__heading">
                    <h2>Using the `rstest` fixture</h2>
                  </div>
                  <div class="doc-prose"><p><code>pg_embedded_setup_unpriv::test_support::test_cluster</code> exposes an <code>rstest</code>
fixture that constructs the RAII guard on demand. Import the fixture so it is
in scope and declare a <code>test_cluster: TestCluster</code> parameter inside an
<code>#[rstest]</code> function; the macro injects the running cluster automatically.</p>
<div class="codehilite" data-language="rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">pg_embedded_setup_unpriv</span><span class="p">::{</span><span class="n">test_support</span><span class="p">::</span><span class="n">test_cluster</span><span class="p">,</span><span class="w"> </span><span class="n">TestCluster</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">rstest</span><span class="p">::</span><span class="n">rstest</span><span class="p">;</span>

<span class="cp">#[rstest]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">runs_migrations</span><span class="p">(</span><span class="n">test_cluster</span><span class="p">:</span><span class="w"> </span><span class="nc">TestCluster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_cluster</span><span class="p">.</span><span class="n">connection</span><span class="p">().</span><span class="n">metadata</span><span class="p">();</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">metadata</span><span class="p">.</span><span class="n">port</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>The fixture integrates with <code>rstest-bdd</code> v0.1.0-alpha4 so behaviour tests can
remain declarative as well:</p>
<div class="codehilite" data-language="rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">pg_embedded_setup_unpriv</span><span class="p">::{</span><span class="n">test_support</span><span class="p">::</span><span class="n">test_cluster</span><span class="p">,</span><span class="w"> </span><span class="n">TestCluster</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">rstest_bdd_macros</span><span class="p">::</span><span class="n">scenario</span><span class="p">;</span>

<span class="cp">#[scenario(path = </span><span class="s">&quot;tests/features/test_cluster_fixture.feature&quot;</span><span class="cp">, index = 0)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">coverage</span><span class="p">(</span><span class="n">test_cluster</span><span class="p">:</span><span class="w"> </span><span class="nc">TestCluster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_cluster</span><span class="p">.</span><span class="n">environment</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>If PostgreSQL cannot start, the fixture panics with a
<code>SKIP-TEST-CLUSTER</code>-prefixed message that retains the original error. Unit
tests fail immediately, while behaviour tests can convert known transient
conditions into soft skips via the shared <code>skip_message</code> helper.</p></div>
                </section>
                <section id="resource-acquisition-is-initialization-raii-test-clusters-connection-helpers-and-diesel-integration" class="doc-section">
                  <div class="doc-section__heading">
                    <h2>Connection helpers and Diesel integration</h2>
                  </div>
                  <div class="doc-prose"><p><code>TestCluster::connection()</code> exposes <code>TestClusterConnection</code>, a lightweight view
over the running cluster's connection metadata. Use it to read the host, port,
superuser name, generated password, or the <code>.pgpass</code> path without cloning the
entire bootstrap struct. When you need to persist those values beyond the guard
you can call <code>metadata()</code> to obtain an owned <code>ConnectionMetadata</code>.</p>
<p>Enable the <code>diesel-support</code> feature to call <code>diesel_connection()</code> and obtain a
ready-to-use <code>diesel::PgConnection</code>. The default feature set keeps Diesel
optional for consumers, while <code>make test</code> already enables <code>--all-features</code> so
the helper is exercised by the smoke tests.</p>
<div class="codehilite" data-language="rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">diesel</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">pg_embedded_setup_unpriv</span><span class="p">::</span><span class="n">TestCluster</span><span class="p">;</span>

<span class="p">#</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">pg_embedded_setup_unpriv</span><span class="p">::</span><span class="n">BootstrapResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="kd">let</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestCluster</span><span class="p">::</span><span class="n">new</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster</span><span class="p">.</span><span class="n">connection</span><span class="p">();</span>
<span class="kd">let</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="n">database_url</span><span class="p">(</span><span class="s">&quot;postgres&quot;</span><span class="p">);</span>
<span class="fm">assert!</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s">&quot;postgresql://&quot;</span><span class="p">));</span>

<span class="cp">#[cfg(feature = </span><span class="s">&quot;diesel-support&quot;</span><span class="cp">)]</span>
<span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">diesel_conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="n">diesel_connection</span><span class="p">(</span><span class="s">&quot;postgres&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="cp">#[derive(QueryableByName)]</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ValueRow</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#[diesel(sql_type = diesel::sql_types::Integer)]</span>
<span class="w">        </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rows</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ValueRow</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diesel</span><span class="p">::</span><span class="n">sql_query</span><span class="p">(</span><span class="s">&quot;SELECT 1 AS value&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">diesel_conn</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">#</span><span class="w"> </span><span class="p">}</span>
</code></pre></div></div>
                </section>
        </article>
      </section>
    </div>
  </main>

  <footer id="footer" class="border-t border-base-200 bg-base-100">
    <div class="layout-shell layout-shell--docs grid gap-12 px-6 py-16 md:grid-cols-3 md:px-16">
      <div>
        <p class="font-mono text-sm font-semibold tracking-[0.3em] text-base-content/90">df12 Productions</p>
        <p class="mt-4 text-sm text-base-content/90">Serious systems, playful worlds. We ship tools that cut build times and stories that map the human edge of complex networks.</p>
      </div>
      <div>
        <h2>OSS &amp; Licences</h2>
        <ul class="mt-4 space-y-2 text-sm">
          <li><a class="footer-link" href="https://github.com/leynos/limela/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">Limela — licence</a></li>
          <li><a class="footer-link" href="https://github.com/leynos/netsuke/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">Netsuke — licence</a></li>
          <li><a class="footer-link" href="https://github.com/leynos/mxd/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">mxd — licence</a></li>
          <li><a class="footer-link" href="https://github.com/leynos/episodic/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">Episodic — licence</a></li>
        </ul>
      </div>
      <div>
        <h3>Stay in touch</h3>
        <ul class="mt-4 space-y-2 text-sm">
          <li><a class="footer-link" data-variant="accent" href="mailto:hello@df12.studio">hello@df12.studio</a></li>
          <li>
            <a class="footer-link" data-variant="accent" href="https://github.com/leynos" target="_blank" rel="noopener noreferrer">
              <iconify-icon icon="carbon:logo-github" class="h-4 w-4" aria-hidden="true"></iconify-icon>
              GitHub
            </a>
          </li>
          <li>
            <a class="footer-link" data-variant="accent" href="https://bsky.app/profile/df12.studio" target="_blank" rel="noopener noreferrer">
              <iconify-icon icon="carbon:logo-bluesky" class="h-4 w-4" aria-hidden="true"></iconify-icon>
              Bluesky
            </a>
          </li>
        </ul>
        <p class="mt-4 text-xs text-base-content/80">Built for curious builders and storytellers everywhere. ©&nbsp;2025&nbsp;df12&nbsp;Productions.</p>
      </div>
    </div>
  </footer>

  <script>
    (() => {
      const blocks = document.querySelectorAll('.codehilite');
      if (!blocks.length) {
        return;
      }

      const formatLanguage = (raw) => {
        const value = (raw || '').trim();
        if (!value || value.toLowerCase() === 'text') {
          return 'Plain Text';
        }
        return value
          .replace(/[._-]+/g, ' ')
          .replace(/\b\w/g, (char) => char.toUpperCase());
      };

      const writeClipboard = async (text) => {
        if (!text) {
          return false;
        }
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (error) {
          /* fall back */
        }

        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.setAttribute('readonly', 'readonly');
          textarea.style.position = 'absolute';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          const success = document.execCommand('copy');
          document.body.removeChild(textarea);
          return success;
        } catch (error) {
          return false;
        }
      };

      blocks.forEach((block) => {
        if (block.dataset.enhanced === 'true') {
          return;
        }
        const pre = block.querySelector('pre');
        const code = block.querySelector('code') || pre;
        if (!pre || !code) {
          return;
        }

        block.dataset.enhanced = 'true';

        const chrome = document.createElement('div');
        chrome.className = 'codehilite__chrome';

        const languageLabel = document.createElement('span');
        languageLabel.className = 'codehilite__language';
        const lang = block.dataset.language || '';
        const readableLang = formatLanguage(lang);
        languageLabel.textContent = readableLang;

        const copyButton = document.createElement('button');
        copyButton.type = 'button';
        copyButton.className = 'codehilite__copy';
        copyButton.setAttribute('aria-label', `Copy ${readableLang} code snippet`);
        copyButton.innerHTML = `
          <span class="codehilite__copy-icon" aria-hidden="true">
            <iconify-icon icon="carbon:copy" class="h-4 w-4"></iconify-icon>
          </span>
          <span class="codehilite__copy-text">Copy</span>
        `;

        chrome.appendChild(languageLabel);
        chrome.appendChild(copyButton);
        block.insertBefore(chrome, pre);

        const copyTextLabel = copyButton.querySelector('.codehilite__copy-text');
        let resetTimer;

        copyButton.addEventListener('click', async () => {
          const textContent = code.textContent || '';
          const didCopy = await writeClipboard(textContent.trimEnd());
          if (!didCopy) {
            let selectionApplied = false;
            if (window.getSelection && document.createRange) {
              const selection = window.getSelection();
              if (selection) {
                try {
                  const range = document.createRange();
                  range.selectNodeContents(code);
                  selection.removeAllRanges();
                  selection.addRange(range);
                  selectionApplied = true;
                  const focusTarget = block.querySelector('pre');
                  if (focusTarget) {
                    if (focusTarget.tabIndex < 0) {
                      focusTarget.tabIndex = -1;
                    }
                    focusTarget.focus({ preventScroll: true });
                  }
                } catch (err) {
                  selectionApplied = false;
                }
              }
            }
            if (copyTextLabel) {
              copyTextLabel.textContent = selectionApplied
                ? 'Press ⌘/Ctrl+C'
                : 'Select the code and press ⌘/Ctrl+C';
            }
            clearTimeout(resetTimer);
            resetTimer = setTimeout(() => {
              copyButton.removeAttribute('data-state');
              if (copyTextLabel) {
                copyTextLabel.textContent = 'Copy';
              }
            }, 2500);
            return;
          }
          copyButton.dataset.state = 'copied';
          if (copyTextLabel) {
            copyTextLabel.textContent = 'Copied';
          }
          clearTimeout(resetTimer);
          resetTimer = setTimeout(() => {
            copyButton.removeAttribute('data-state');
            if (copyTextLabel) {
              copyTextLabel.textContent = 'Copy';
            }
          }, 2500);
        });
      });
    })();
  </script>
<script
  src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"
  defer
  integrity="sha384-GPb5RlngihS9H0z1D137JsvzmeZ7tCpWEF4t5YDoTZyMsPP8S7h7vFDh4XhheU83"
  crossorigin="anonymous"
></script>
</body>
</html>